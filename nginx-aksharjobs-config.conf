# ============================================================================
# SAFE Nginx Configuration for aksharjobs.com/yatra
# ============================================================================
# 
# IMPORTANT: This configuration ONLY adds the /yatra path to your existing site.
# It will NOT affect any existing routes or functionality on aksharjobs.com
#
# HOW TO USE:
# 1. Backup your current nginx config: sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup
# 2. Add ONLY the location blocks below to your existing server block for aksharjobs.com
# 3. Test the config: sudo nginx -t
# 4. If test passes, reload: sudo systemctl reload nginx
#
# NOTE: If your existing site already uses /api path, you may need to:
# - Use a different path like /yatra-api instead
# - Or make the /api location more specific (e.g., /api/yatra/...)
# ============================================================================

# Location block for /yatra path - ONLY matches /yatra and sub-paths
# This is safe and won't interfere with your existing website
location ^~ /yatra {
    # Proxy to your Yatra frontend server
    # IMPORTANT: Update this to match your actual Yatra frontend server
    # Option 1: If Yatra frontend runs on a different port (e.g., 8080)
    proxy_pass http://localhost:8080;
    
    # Option 2: If Yatra frontend runs on a different server
    # proxy_pass http://your-yatra-server-ip:port;
    
    # Option 3: If serving static files directly
    # alias /var/www/yatra-frontend/html;
    # try_files $uri $uri/ /yatra/index.html;
    
    proxy_http_version 1.1;
    
    # Preserve headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /yatra;
    
    # WebSocket support
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffer settings
    proxy_buffering off;
    proxy_request_buffering off;
}

# API endpoints for Yatra backend
# WARNING: Only add this if your existing site does NOT use /api path
# If your site already uses /api, comment this out and use /yatra-api instead
# Then update the API_BASE in yatra-frontend/api-integration.js accordingly
location ^~ /api {
    # Proxy to your Yatra backend API server
    # IMPORTANT: Update this to match your actual backend server
    # If backend runs on port 3000:
    proxy_pass http://localhost:3000;
    
    # If backend runs on a different server:
    # proxy_pass http://your-backend-server-ip:3000;
    
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # CORS headers (backend should handle this, but adding as backup)
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Credentials "true" always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}

# ============================================================================
# ALTERNATIVE: If your site already uses /api, use this instead:
# ============================================================================
# location ^~ /yatra-api {
#     proxy_pass http://localhost:3000;
#     proxy_http_version 1.1;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     
#     add_header Access-Control-Allow-Origin $http_origin always;
#     add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
#     add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
#     add_header Access-Control-Allow-Credentials "true" always;
#     
#     if ($request_method = 'OPTIONS') {
#         add_header Access-Control-Allow-Origin $http_origin always;
#         add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
#         add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
#         add_header Access-Control-Allow-Credentials "true" always;
#         add_header Content-Length 0;
#         add_header Content-Type text/plain;
#         return 204;
#     }
# }
# ============================================================================
